<!DOCTYPE html>
<html>
<head>

    <title th:text="#{application.title}">the title of the application</title>

    <!--[if lt IE 9]>
    <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <script type="text/javascript" th:src="@{/assets/js/json2.js}"></script>
    <script type="text/javascript" th:src="@{/assets/js/jquery-1.6.2.min.js}"></script>
    <script type="text/javascript" th:src="@{/assets/js/jquery-ui-1.8.16.custom.min.js}"></script>
    <script type="text/javascript" th:src="@{/assets/js/jquery.filedrop.js}"></script>
    <script type="text/javascript" th:src="@{/assets/js/upload.js}"></script>

    <link th:href="@{/assets/css/styles.css}" rel="stylesheet" type="text/css"/>

    <style type="text/css">
        .hideme {
            display: none;
        }

        body {
            font-family: sans-serif;
            font-size: smaller;
        }

        #ecs {
            border: 1px solid gray;
            border-top: 0 solid gray;
            background-color: #d3d3d3;
        }

        #expenseReport {
            border: 1px solid #90ee90;
            background-color: #f5fffa;
            min-width: 400px;
            float: left;
            height: 400px;
            margin-left: 10px;
            float: left;
        }

        .ec {
            padding: 5px;
        }

        #ecsBalance {

            padding: 5px;
            padding-left: 155px;
            width: 60px;
            display: inline-block;
        }

        .ec {
            cursor: move;
            border-top: 1px solid gray;
            background-color: #d3d3d3;
        }

        .ui-draggable-dragging {
            border: 1px solid gray;
        }

        .ec .merchant {
            display: inline-block;
            width: 150px;
            font-size: inherit;
        }

        .ec .category {
            font-size: smaller;
            text-transform: uppercase;
            color: gray;
            letter-spacing: 1px;
        }

        .ec .amount {
            display: inline-block;
            width: 60px;
        }

        .dollar {
            color: gray
        }

        #ecsPanel {
            float: left;

            display: inline-block;
            width: 350px;
        }
    </style>

</head>
<body>

<div id="ecsPanel">
    <div id="ecs"></div>
    <div id="ecsBalance"></div>
</div>

<div id="dropbox">
    <span class="message">
    </span>
</div>

<div id="expenseReport">


</div>

<!-- configuration information -->
<span id="ecUrl" class="hideme" th:text="@{/reports/eligible-charges/}"/>
<span id="createErUrl" class="hideme" th:text="@{/reports}"/>
<span id="newReportString" class="hideme" th:text="#{label.createNewReport}"/>
<span id="createExpenseReportExpenseUrl" class="hideme" th:text="@{/reports/reportId/expenses}"/>

<script lang="javascript" type="text/javascript">
    <!--

    // some global urls
    var createExpenseReportExpenseUrl = $('#createExpenseReportExpenseUrl').html();
    var newReportString = $('#newReportString').html();
    var eligibleChargesUrl = $('#ecUrl').html();
    var createErUrl = $('#createErUrl').html();

    var currentEligibleCharge = null; // global variable to hold the current EC
    var expenseReport = null;
    var currentExpenseReport = null;

    function renderPrice(p) {
        return '<span class = "dollar">$</span> ' + p;
    }

    /**
     *  the results have data that looks like this:
     *   [ .., .., {"id":4,"date":1287730800000,"amount":22.40,"category":"food","merchant":"Denny's","i":4}, ... ]
     * @param callback
     */
    function loadEligibleCharges(callback) {
        var eligibleCharges = [];
        $.ajax({
            url: eligibleChargesUrl,
            success: function(data) {
                callback(data);
            }
        });
    }

    function drawEligibleCharge(ecsNode, ec) {
        var ecId = 'ec' + ec.id;
        $(ecsNode).append("<div id='" + ecId + "' class = 'ec'> <span class ='merchant'> " +
                ec.merchant + "</span>" + "<span class ='amount'>" +
                renderPrice(ec.amount) + "</span>" +
                " <span class='category'>" + ec.category + "</span> " +
                "</div>");

        $('#' + ecId).draggable({
            revert : 'invalid', // ie, itll revert if its not dropped
            start : function () {
                currentEligibleCharge = ec;
            },
            stop : function () {
            },
            drag : function () {
            }
        });
    }

    function createExpenseReportIfRequired(purpose, cb) {

        if (currentExpenseReport == null) {
            $.post(createErUrl, { purpose :  purpose }, function(result) {
                var resultingId = parseInt(result);
                currentExpenseReport = resultingId;
                cb(purpose, currentExpenseReport);
            });
        } else {
            cb(purpose, currentExpenseReport);
        }
    }

    function addEligibleChargeToReport(ec, cb) {
        createExpenseReportIfRequired(newReportString, function(purpose, reportId) {
            var url = createExpenseReportExpenseUrl.replace('reportId', reportId);
            var obj = { chargeId : ec.id   };
            $.post(url, {  chargeId  :  ec.id }, function(result) {
                var expense = result [0];

            });

        });
    }

    $(function() {

        expenseReport = $('#expenseReport');

        // setup the drop zone
        expenseReport.droppable({
            drop: function(event, ui) {
                var draggable = ui.draggable;
                var ec = currentEligibleCharge;
                addEligibleChargeToReport(ec, function(purpose, currentExpenseReportId) {
                    alert('going to add an expense ' + ec.id + ' item to report ' + currentExpenseReportId);

                });
            }
        });

        loadEligibleCharges(function(data) {
            var ecs = $('#ecs');
            var total = 0.0;
            for (var i = 0; i < data.length; i++) {
                drawEligibleCharge(ecs, data[i]);
                total += data[i].amount;
            }
            $("#ecsBalance").html(renderPrice(total));

        });

    });

    //-->
</script>
</body>
</html>